---
title: Characterizing Berlin's Districts Through Yelp Data
author: Gershom Tripp
date: '2018-12-14'
slug: characterizing-berlin-s-districts-through-yelp-data
categories: []
tags:
  - Berlin
  - Dataviz
  - Germany
  - Maps
  - R
  - Yelp
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{r load_packages, include=FALSE}
library(tidyverse)
library(ggmap)
```

```{r load_data, include=FALSE}
# load cleaned yelp data (found here: https://github.com/GershTri/yelp-r)
load("datasets/yelp/berlin_yelp.rda")
load("datasets/berlin_demographics/berlin_demo_sf_info.rda")
rm(pol_parties, info_district_df, sf_plz_berlin)
```

```{r reduce_restructure_yelp_df, include=FALSE}
# extract categories from categories.title.1
cat_titles1 <- yelp_df %>% 
    filter(!is.na(categories.title.1)) %>% 
    select(-categories.title) %>% 
    rename(categories.title = categories.title.1)

# extract categories from categories.title.2
cat_titles2 <- yelp_df %>% 
    filter(!is.na(categories.title.2)) %>% 
    select(-categories.title) %>% 
    rename(categories.title = categories.title.2)

# recombind above data frames with yelp_df and remove unneeded variables
yelp_df <- bind_rows(yelp_df, cat_titles1, cat_titles2) %>% 
    select(-c(alias, image_url, is_closed, url, starts_with("categories.alias"),
              starts_with("location.address"), starts_with("location.disp"),
              phone, display_phone, starts_with("categories.title."),
              location.country
              )
           )

rm(cat_titles1, cat_titles2)
```









## Introduction

***

What follows is an EDA of Yelp reviewed businesses in Berlin, Germany. 

This blogpost represents a couple of firsts. For one, it is the product of of my
very first foray into the world of geospatial data, including maps, decimal 
degrees, dot density plots, choropleth maps (not included below, but coming soon),
etc.

It's also my first largish independent project. I've been coding for a while now, 
and I've done countless EDA's, but I have not yet compiled my findings in a 
document that is meant to be read by others - look at Mr. Optimistic, assuming 
people are going to read this!

And finally, it's my first blogpost ever. I've taken David Robinson's
[advice](http://varianceexplained.org/r/start-blog/) and set up my own blog
cum portfolio, and I intend to add to it regularly. Hopefully the internets will
treat me kindly.

I can't claim the idea for this post as my own. I've take quite a lot of inspiration
from Amber Thomas' and Ilia Blinderman's [**A Tail of Two Cities**](https://pudding.cool/2018/03/neighborhoods/),
where they did a similar (and much cooler) analysis of Seattle and NYC. They, in 
turn, were inspired by Katie Hempenius'
[analysis](https://katiehempenius.com/post/yelp-map-of-san-francisco/) of San 
Francisco's Yelp reviews. I highly recommend both analyses.



Note that I frequently use the term _district_ in place of _neighborhood_. 







<br><br>

## Getting the Data

***

The data were collected using the official Yelp 
[_Fusion_](https://www.yelp.de/developers/documentation/v3) API. Yelp's API isn't
really made for bulk downloading data, although this is allowed for non-commercial
analyses such as the one you have before you, so there are a couple of request limits
to contend with. There might be a more refined solution, but what worked for me was to
divide Berlin into a grid of 500x500 meter blocks and then "scan" Berlin from 
top to bottom and left to right.

This method, although effective, did have one unforeseen pitfall: The data 
developed very regular vertical striations (e.g. in a dot density map) in the 
southern part of the grid, and particularly in the southeast. After a moment of
frustration I hit on the idea that longitudinal lines don't run parallel, they
converge at the poles and spread as they approach the equator, so the same
longitudinal coordinates represent different distances at different latitudes.
Consequently, the search radius should be increased incrementally as the scan 
moves south.

This strategy, being more ax than scalpel, generates **a lot** of duplicates. After 
removing them I ended up with `r length(unique(yelp_df$id))` unique listings for 
Berlin and Potsdam, the latter of which is a small city just outside of Berlin.











<br><br>

## A Brief Analysis of Yelp-Reviewed Businesses in Berlin

***

Before I get to the districts, I 

First, a glimpse of the data.

```{r show_glimpse}
# filter for berlin and potsdam
yelp_df <- yelp_df %>% 
    filter(location.state == "BE" | location.city %in% c("Berlin", "Potsdam"))

glimpse(yelp_df)
```

As I mentioned above, the number of unique listings for Berlin and Potsdam is 
just under 12,000. The 17,976 you see here is due the fact that some listings 
belong to multiple categories. I haven't been able to discern any kind of 
consistent hierarchy (i.e. supercategories and subcategories), so every 
A dot density plot can give some perspective on the distribution of Yelp-reviewed
businesses. The colors correspond to Berlin's 12 administrative districts and 
Potsdam, a town to the southwest of Berlin. The names of the districts aren't 
important at this point. Interesting is the disparity in the spatial density of
Yelp-reviewed businesses between districts.

```{r plot_dot_density_all_businesses, message=FALSE, warning=FALSE}
berlin_coord <- c(left = 12.9680, bottom = 52.3219, right = 13.8000, top = 52.6918)
berlin_map <- get_stamenmap(berlin_coord, maptype = "toner-background")

yelp_df[is.na(yelp_df$district), "district"] <- "Potsdam"

berlin_map %>% 
    ggmap(darken = .8) +
    geom_point(data = yelp_df %>%
                   select(id,
                          coordinates.latitude,
                          coordinates.longitude,
                          district
                          ) %>% 
                   distinct(),
               aes(coordinates.longitude,
                   coordinates.latitude,
                   color = district
                   ),
               size = 0.1,
               alpha = .3
               ) + 
    ggtitle("Distribution of All Yelp-Reviewed Businesses") + 
    theme(axis.text = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5),
          legend.position = "none"
          )
```



```{r plot_30_categories_with_most_listings}
#
yelp_df %>% 
    group_by(categories.title) %>% 
    count() %>% 
    arrange(desc(n)) %>%
    head(30) %>% 
    rename(Category = categories.title, Count = n) %>% 
    ungroup() %>% 
    mutate(Category = factor(Category,
                             ordered = T,
                             levels = rev(.$Category)
                             )
           ) %>% 
    ggplot(aes(y = Category, x = Count)) +
    geom_point(shape = 21, fill = "lightblue", size = 2) + 
    scale_x_continuous(breaks = seq(100, 1700, 200)) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank()
          ) + 
    ggtitle("Thirty Categories with the Most Yelp Listings")
```

```{r plot_30_categories_with_most_reviews_per_listing}
#
yelp_df %>% 
    group_by(categories.title) %>% 
    summarise(mean_review = mean(review_count, trim = .1)) %>% 
    arrange(desc(mean_review)) %>%
    head(30) %>% 
    rename(Category = categories.title) %>% 
    ungroup() %>% 
    mutate(Category = factor(Category,
                             ordered = T,
                             levels = rev(.$Category)
                             )
           ) %>% 
    ggplot(aes(y = Category, x = mean_review)) +
    geom_point(shape = 21, fill = "#F1C40F", size = 2) + 
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank()
          ) + 
    ggtitle("Thirty Categories with Most Reviews (Mean) per Listing") +
    xlab("Reviews per Listing (Mean)")
```


```{r plot_30_businesses_with_most_reviews}
# 
yelp_df %>% 
    arrange(desc(review_count)) %>%
    select(-categories.title) %>% 
    distinct() %>% 
    head(30) %>% 
    mutate(name = ordered(name, levels = rev(.$name))) %>%
    ggplot(aes(y = name, x = review_count)) +
    geom_point(shape = 21, fill = "salmon", size = 2) + 
    scale_x_continuous(breaks = seq(250, 1000, 150)) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank()
          ) +
    xlab("Number of Reviews") +
    ggtitle("Thirty Businesses with the Most Yelp Reviews")
```

A histogram can show us the distribution of reviews, specifically the number of 
reviews per listing. Here we can see that the bulk of the listings have less
than 100 reviews, so the businesses in the 

```{r plot_histogram_review_count_per_listing, warning=F, message=F}
yelp_df %>% 
    select(-categories.title) %>% 
    distinct() %>%
    select(review_count) %>% 
    ggplot(aes(x = review_count)) +
    geom_histogram(color = "black", fill = "#2471A3", bins = 16) + 
    scale_x_log10() + 
    scale_y_continuous(breaks = seq(0, 2500, 500)) +
    theme_minimal() + 
    theme(panel.grid.minor.x = element_blank()
          ) + 
    ggtitle("Histogram of Review Count per Yelp Listing") + 
    xlab("Review Count (Logarithmic)")
    
```

```{r}
review_mean_df <- yelp_df %>% 
    group_by(categories.title) %>% 
    count() %>% 
    rename(Listings = n) %>% 
    full_join(yelp_df %>%
                  group_by(categories.title) %>% 
                  summarise(review_mean = mean(review_count)),
              by = "categories.title"
              )

review_mean_df$bin <- cut(review_mean_df$Listings,
                          breaks = seq(0, 1700, 100),
                          labels = as.character(seq(100, 1700, 100))
                              )


review_mean_less_100_df <- review_mean_df %>% 
    filter(Listings < 101)

review_mean_less_100_df$bin <- cut(review_mean_less_100_df$Listings,
                                   breaks = seq(0, 100, 5),
                                   labels = as.character(seq(5, 100, 5))
                                   )

ggplot(review_mean_df, aes(x = bin, y = review_mean)) +
    geom_boxplot()

ggplot(review_mean_less_100_df, aes(x = bin, y = review_mean)) +
    geom_boxplot()

review_mean_less_100_df %>% 
    filter(bin == "5", review_mean > 35) %>% 
    arrange(desc(review_mean))

yelp_df %>%
    ggplot(aes(x = rating)) +
    geom_histogram(binwidth = .5, color = "black", fill = "#2471A3") +
    scale_x_continuous(breaks = seq(0, 5, .5)) +
    theme_minimal() + 
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()
          ) + 
    labs(title = "Distribution of Reviews (0-5 Stars)")
    

# yelp_df %>%
#     filter(categories.title == "Sri Lankan") %>% 
#     select(name, review_count)
```









<br><br>

#### Berliner's Love Value.



```{r number_of_listings_in_each_price_class, warning=F, message=F}
yelp_df %>% 
    select(-categories.title) %>% 
    distinct() %>% 
    select(price) %>% 
    filter(!is.na(.)) %>%
    group_by(price) %>% 
    count() %>% 
    filter(price != "$$") %>% 
    ungroup() %>% 
    mutate(price = factor(.$price,
                          ordered = T,
                          levels = c("€", "€€", "€€€", "€€€€")
                          )
           ) %>% 
    ggplot(aes(x = price, y = n, fill = price)) +
    geom_bar(stat = "identity", color = "black") + 
    theme_minimal() + 
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          legend.position = "none"
          ) + 
    ggtitle("Number of Listings in Each Price Class") + 
    xlab("Price Class") + 
    ylab("Count")
```


## Deciding on a Metric

Ilia Blinderman and Amber Thomas [rely](https://pudding.cool/2018/03/neighborhoods/)
on Katie Hempenius's "incidence rate" metric from her 
[analysis](https://katiehempenius.com/post/yelp-map-of-san-francisco/) of San
Francisco's neighborhoods, so I will address Katie's arguments directly. I recommend reading Katie's post for a complete understanding of how she arrived at her metric, but we might summarize her reasoning thusly: 

$$
X = \frac{category_{Z}\;in\;district_{X}}{category_{Z}\;in\;city} \times
\frac{businesses\;in\;city}{businesses\;in\;district_{X}}
$$

I have a number of complaints regarding this metric, ranging from minor to major.
I'll deal with two issues first that I regard as minor since they really have no
bearing on Katie's, Ilia's, and Amber's conclusions. Still, I think they are worth
briefly discussing, if only for the sake of clarity.

My first complaint has to do with terminology. Simply put, the above formula does not represent the incidence rate. The _incidence rate_ has a [specific meaning](https://www.cdc.gov/ophss/csels/dsepd/ss1978/lesson3/section2.html), particularly in epidemiology, but also in the business realm. It is namely a measure of _new cases_ in a specified period of _time_. Time is not, however, factored into the above formula. In reality, this formula is more of a riff on _prevalence_, which gives us the proportion of existing cases in the population as a whole. Here our population consists of all city-wide members of 
category~Z~, and our cases are any members of category~Z~ found in district~X~. From here on out I'll refer to this prevalence as prevalence~CC~ (to be contrasted with prevalence~CB~, which I shall discuss shortly).

I would like to add that using the incidence rate in this way is, although not really correct, also
perfectly understanable. _Incidence_ is, after all, commonly used to indicate 
the _occurence_ of something. In fact, most dictionary [definitions](https://www.dictionary.com/browse/incidence) 
reflect just this usage, and incidence, occurence, and prevalence are frequently treated as [synonyms](https://www.thesaurus.com/browse/incidence). Nevertheless, the incidence rate has a more specific meaning than incidence alone, and since an _epidemiology of Yelp-reviewed businesses_ sounds like a perfectly reasonable approach, I think it's worth splitting a few hairs here.

An even less pressing issue, but perhaps relevant in terms of computational resources,
is the second half of the equation, which helps to "normalize for the effects of
commercial versus residential usage", as Katie puts it. This step normalizes
the prevalences~c/c~ by scaling them upwards by an amount equal to the number of times 
larger the city-wide business population is than each district's respective business population.
That means districts with fewer businesses receive a greater boost, so their prevalences~c/c~
can be compared directly with those of districts with more businesses.

The following exampl should hopefully make things clearer, while also offering a basis
for my objection. The data is for two districts of a hypothetical city.
Many of the column names should be more or less self-explanatory once you understand the 
basic abbreviations: Districts = `dist`, businesses = `bus`, categories = `cat`, total = `tot`.

The first table simply shows the category members and total businesses at the district
and city level:

```{r table_between-district_data}
bd_df <- tibble(
    dist = c("D_1", "D_1", "D_2", "D_2"),
    cat = c("C_1", "C_2", "C_1", "C_2"),
    cat_dist_tot = c(15, 10, 150, 100),
    cat_city_tot = 1000,
    "cat_dist/cat_city" = cat_dist_tot/cat_city_tot,
    bus_dist_tot = c(100, 100, 1000, 1000),
    bus_city_tot = 10000,
    "bus_city/bus_dist" = bus_city_tot/bus_dist_tot,
    "(c_d/c_c)*(b_c/b_d)" = `cat_dist/cat_city` * `bus_city/bus_dist`,
    "cat_dist/bus_dist" = cat_dist_tot/bus_dist_tot
)

bd_df %>% 
    select(1:4, 6, 7) %>% 
    knitr::kable()
```

The second table includes the calculations we can make from the first table's data.
Particularly important are the columns `cat_dist/cat_city`, which shows us the prevalence~CC~, 
and `(c_d/c_c)*(b_c/b_d)`, which shows the _normalized_ prevalence~CC~:

```{r table_between-district_calculations}
bd_df %>% 
    select(1, 2, 5, 8:10) %>% 
    knitr::kable()
```


We should notice a couple of things here. First, normalizing the prevalences~c/c~ allows
us to compare the between-district, within-category rankings, e.g. we can see that
C~1~ is equally prevalent in D~1~ and D~2~ once we control for differences in the 
total number of businesses in each district. On the other hand, the within-district, 
between-category rankings remain unaffected.

And therein lies the crux of the problem: Katie, Ilia, and Amber appear to have only used the within-district, between-category
rankings to characterize their cities' districts, which means normalizing the data 
in this way was unnecessary. Ergo, a simplified version of Katie's formula would work just as well:

$$
X = \frac{category_{Z}\;in\;district_{X}}{category_{Z}\;in\;city}
$$

To be clear, I don't mean to imply that between-district rankings are unimportant.
On the contrary, I've implemented it as part of my own proposed method below.
It is also fully possible that I've missed something. Katie's code doesn't seem
to be available, and Ilia and Amber's data has already been thoroughly processed, 
so it's impossible to replicate some necessary steps without downloading all the
Yelp data they used, which is more work than I'm prepared to do right now. If you 
happen to find some mistakes in my reasoning, please feel free to point them out
in the comments.


With the minor issues cleared up, we can now turn to the what I see as the major
drawbacks of the prevalence~CC~. 

1. **It ignores differences in total business frequency**. If 10 of 20 city-wide members of 
   category C~1~ are found in a district, and 100 of 200 city-wide members of
   category C~2~ are found in the same district, then prevalence~CC~ tells us 
   that the neighborhood is equally characterized by C~1~ and C~2~ (10/20 = 0.5
   and 100/200 = 0.5). Even worse, if C~2~ has 210 instead of 200 city-wide 
   members, then the formula tells us that C~1~ characterizes the neighborhood 
   _better_ than C~2~, even though C~2~ occurs 10 times more than C~1~ in the district!
2. **It is biased in favor of small sample sizes**. Different types of businesses
   likely aren't distributed evenly across a city. Especially small populations
   of niche businesses might be more likely be clustered in one area. For example,
   vegan restaurants might be fairly rare in the city as a whole, but in one
   particulary trendy neighborhood
   you might find a cluster of them. As is the nature of things, "trendy" 
   neighborhoods are often also gentrifying inner-city areas with large minority
   communities. If the minority population is dispersed throughout the rest of 
   the city at a rate greater than the vegan restaurants, then the above formula 
   would suggest that the neighborhood is better characterized as "vegan" than 
   as Black, Latino, Arabic, Indian, etc. even if these communities and cultures are far
   more prominent in everyday life. Of course, it's still important to know that
   there are more vegan restaurants in one neighborhood than anywhere else, but 
   neighborhood's uniqueness should not be determined primarily by the general 
   scarcity of some of its businesses. (Note: This principle holds true for any
   businesses. My example h)
3. **It doesn't take into account variations in the total number of businesses**.
   Two neighborhoods might both be home to 20 of 100 total category members, i.e.
   each has 20% of the whole, but neighborhood _x_ has a total of 2,000 businesses,
   while neighborhood _y_ only has 200. Should we say that the category characterizes
   both neighborhoods equally? Probably not.
4. **It ignores other indicators of interest**. It would be reasonable to view
   the number of listings for a given category in a district as one indication 
   of interest. For example, if we assume that two districts D~1~ and D~2~ have,
   in reality, the same number of instances of C~x~, but there are more
   Yelp listings for that category in D~1~ than in D~2~, then we could
   hypothesize C~x~ generates more interest in D~1~ than in D~2~, and that it thus
   characterizes D~1~ better than D~2~. But what if the C~x~ listings in D~2~ 
   have more reviews on average? 
   
   
   

With the above 

$$
score = 
prevalence_{CB} \times
prevalence_{CC} \times
interest
$$
Each part of this formula brings its own advantages and disadvantages. For 
instance, prevalence might tell us what occurs the most, but it doesn't tell us
anything about less prevalent businesses that might still be important in some
other way, e.g. in terms of 

$$
score = 
\left(
    \frac{category_{zip}}{businesses_{zip}} - 
    \frac{category_{city}}{businesses_{city}}
\right) \times
\frac{category_{zip}}{category_{city}} \times
\frac{reviews_{mean/zip}}{reviews_{mean/city}}
$$

I'll refer to the first part as the _relative prevalence_, since it is a measure
of district-level prevalence relative to the city-level prevalence. I've chosen 
to use the relative prevalence, instead of just the district-level prevalence,
because it is a better indicator of how the district is different from the city
as a whole. It also offers a handy cut-off: Anything less than 0 is less prevalent
in the district than in the city, and anything more than 0 is more prevalent in
the district than in the city. It's then just a matter of sorting the relative 
prevalences from greatest to least to find the categories that are overrepresented
in the district.





As a virtuous programmer (I try 🤷) I'll attempt to zero in on a good solution
via edge cases, which I can formulate in a series of what-ifs:

Dropping categories with small sample sizes (Ilia and Amber set a threshold of
1% of a district's businesses) ignores the issue posed by _1._, i.e. that a 
neighborhood might be characterized by a small number of unusual businesses, or
perhaps a single, very large institution. 

I think most of the confusion here stems from the fact that specific epidemiological terminology is being used in a context where an epidemological approach is perfectly valid, but how the terminology is being used isn't quite right.


Using the proportion `category in district/category in city` can be misleading.





<br>

## Friedrichshain-Kreuzberg

```{r set_up_color_map_function}
district_color_map <- unique(sf_districts$Districts)
district_color_map <- data_frame(district = district_color_map, color = "grey")

district_name <- "Friedrichshain-Kreuzberg"

highlight_district <- function(district_name, color_map = district_color_map){
    color_map[which(color_map$district == district_name), "color"] <- "red"
    color_map
}

```

```{r highlight_friedrichshain_kreuzberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Friedrichshain-Kreuzberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r set_up_dataframe_of_prevalence_diffs, message=FALSE, warning=FALSE}

# calculate category prevalence for city
preval_city_df <- yelp_df %>% 
    group_by(categories.title) %>% 
    summarise(cat_tot_city = n()) %>% 
    mutate(bus_tot_city = length(unique(yelp_df$id)),
           preval_city = cat_tot_city/nrow(yelp_df))

# calculate category prevalence for districts
preval_dist_df <- yelp_df %>% 
    group_by(district, categories.title) %>% 
    count() %>%
    full_join(yelp_df %>%
                  group_by(district) %>%
                  count(),
              by = "district"
              ) %>% 
    rename(cat_tot_dist = n.x, bus_tot_dist = n.y) %>% 
    mutate(preval_dist = cat_tot_dist/bus_tot_dist)

#
rev_dist_df <- yelp_df %>% 
    group_by(district, categories.title) %>% 
    summarise(review_dist_sum = sum(review_count),
        review_dist_mean = mean(review_count, trim = .1)) %>% 
    full_join(yelp_df %>%
                  group_by(categories.title) %>%
                  summarise(review_city_sum = sum(review_count),
                      review_city_mean = mean(review_count, trim = .1)),
              by = "categories.title"
              ) %>% 
    mutate(review_prop = review_dist_mean/review_city_mean) %>% 
    group_by(district) %>% 
    mutate(review_dist_all = sum(review_dist_sum),
           review_dist_prop = review_dist_sum/review_dist_all
           )

# calculate category prevalence * proportion reviews for district
preval_prop_dist_df <- preval_dist_df %>% 
    full_join(preval_city_df,
              by = "categories.title"
              ) %>% 
    mutate(preval_diff = preval_dist - preval_city,
           prop_cat = cat_tot_dist/cat_tot_city
           ) %>% 
    full_join(rev_dist_df,
              by = c("district", "categories.title")
              ) %>% 
    mutate(preval_x_catprop_x_revprop = preval_diff * prop_cat * review_prop) %>%
    filter(preval_dist > 0.01 | review_dist_prop > 0.01) %>% 
    arrange(district, desc(preval_x_catprop_x_revprop))

categories <- unique(preval_prop_dist_df$categories.title)
categ_list <- vector(mode = "list", length = length(categories))
names(categ_list) <- categories

for (category in categories) {
    categ_list[[category]] <- preval_prop_dist_df %>% 
        filter(categories.title == category) %>% 
        arrange(desc(preval_diff)) %>% 
        head(4)
}

final_df <- bind_rows(categ_list) %>% 
    arrange(district, desc(preval_x_catprop_x_revprop))
```

```{r}
d <- "Friedrichshain-Kreuzberg"

prop_cat_df <- preval_prop_dist_df %>%
    filter(district == d) %>% 
    arrange(desc(prop_cat)) %>% 
    head(5) %>%
    mutate(Method = "Category Proportion")

preval_dist_df <- preval_prop_dist_df %>%
    filter(district == d) %>% 
    arrange(desc(preval_dist)) %>% 
    head(5) %>%
    mutate(Method = "Prevalence")

preval_diff_df <- preval_prop_dist_df %>%
    filter(district == d) %>% 
    arrange(desc(preval_diff)) %>% 
    head(5) %>%
    mutate(Method = "Relative Prevalence")

review_prop_df <- preval_prop_dist_df %>%
    filter(district == d) %>% 
    arrange(desc(review_prop)) %>% 
    head(5) %>%
    mutate(Method = "Review Proportion")

preval_x_catprop_x_revprop_df <- preval_prop_dist_df %>%
    filter(district == d) %>% 
    arrange(desc(preval_x_catprop_x_revprop)) %>% 
    head(5) %>%
    mutate(Method = "RelPre x CatPro x RevPro")

preval_x_catprop_x_revprop_filter_df <- final_df %>%
    filter(district == d) %>% 
    arrange(desc(preval_x_catprop_x_revprop)) %>% 
    head(5) %>%
    mutate(Method = "RP x CP x RP + Comp")

bind_rows(list(prop_cat_df, preval_dist_df, preval_diff_df, review_prop_df,
               preval_x_catprop_x_revprop_df, preval_x_catprop_x_revprop_filter_df
               )
          ) %>%
    ungroup() %>% 
    mutate(Method = factor(Method, levels = unique(.$Method))
           ) %>% 
    ggplot(aes(x = categories.title, y = cat_tot_city, fill = Method)) +
    geom_bar(stat = "identity") +
    geom_hline(yintercept = 0) +
    coord_flip() +
    facet_wrap(~Method) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust = 1),
          axis.text.y = element_text(size = 7),
          legend.position = "none"
          ) +
    ylab("City-Wide Prevalence") +
    ggtitle("A Comparison of Metrics")
```


```{r write_plot_district_function}
plot_district <- function(district_name, coords) {
    
    dist_preval_df <- final_df %>% 
        filter(district == district_name) %>% 
        head(8)
    
    dist_df <- yelp_df %>% 
        filter(district == district_name,
               categories.title %in% dist_preval_df$categories.title
               ) %>% 
        mutate(categories.title = ordered(categories.title,
                                          levels = dist_preval_df$categories.title
                                          )
               )
    
    coords_df <- tibble(lon = coords[c("top", "bottom")],
                        lat = coords[c("right", "left")]
                        )
    
    qmplot(data = coords_df,
           x = lat,
           y = lon,
           maptype = "terrain",
           geom = "blank"
           ) +
        geom_point(data = dist_df, 
                   aes(x = coordinates.longitude,
                       y = coordinates.latitude,
                       shape = I(21),
                       fill = I("red"),
                       size = review_count,
                       alpha = .5

                       ),
                   ) +
        facet_wrap(~ categories.title, ncol = 2) +
        theme_minimal() +
        theme(axis.title = element_blank(),
              axis.text = element_blank(),
              axis.ticks = element_blank(),
              strip.text = element_text(size=12),
              legend.position = "none"
              )
}

```

```{r plot_top_6_friedrichshain_kreuzberg, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5193, right = 13.4677, bottom = 52.4730, left = 13.3535)
plot_district("Friedrichshain-Kreuzberg", coords = coords)

```









<br>

## Mitte

```{r highlight_mitte, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Mitte")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r plot_top_6_mitte, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5794, right = 13.4797, bottom = 52.4870, left = 13.2514)
plot_district("Mitte", coords = coords)

```











<br>

## Charlottenburg-Wilmersdorf

```{r highlight_charlottenburg_wilmersdorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Charlottenburg-Wilmersdorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```



```{r plot_top_6_charlottenburg_wilmersdorf, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5542, right = 13.3781, bottom = 52.4618, left = 13.1498)
plot_district("Charlottenburg-Wilmersdorf", coords = coords)

```









<br>

## Steglitz-Zehlendorf

```{r highlight_steglitz_zehlendorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Steglitz-Zehlendorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r plot_top_6_steglitz_zehlendorf, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5221, right = 13.4583, bottom = 52.3368, left = 13.0016)
plot_district("Steglitz-Zehlendorf", coords = coords)

```








<br>

## Tempelhof-Schöneberg

```{r highlight_tempelhof_schöneberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Tempelhof-Schöneberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_tempelhof_schöneberg, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5329, right = 13.6021, bottom = 52.3477, left = 13.1455)
plot_district("Tempelhof-Schöneberg", coords = coords)

```











<br>

## Neukölln

```{r highlight_neukoelln, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Neukölln")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_neukoelln, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5384, right = 13.6903, bottom = 52.3532, left = 13.2337)
plot_district("Neukölln", coords = coords)

```








<br>

## Treptow-Köpenick

```{r highlight_treptow_koepenick, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Treptow-Köpenick")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_treptow_koepenick, warning=F, message=F, fig.height=10}

coords <- c(top = 52.5108, right = 13.8287, bottom = 52.3255, left = 13.3721)
plot_district("Treptow-Köpenick", coords = coords)

```








<br>

## Marzahn-Hellersdorf

```{r highlight_marzahn_hellersdorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Marzahn-Hellersdorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_marzahn_hellersdorf, warning=F, message=F, fig.height=10}

coords <- c(top = 52.6147, right = 13.8160, bottom = 52.4299, left = 13.3594)
plot_district("Marzahn-Hellersdorf", coords = coords)

```









<br>

## Lichtenberg

```{r highlight_lichtenberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Lichtenberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_lichtenberg, warning=F, message=F, fig.height=10}

coords <- c(top = 52.6243, right = 13.7401, bottom = 52.4395, left = 13.2835)
plot_district("Lichtenberg", coords = coords)

```







<br>

## Pankow

```{r highlight_pankow, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Pankow")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_pankow, warning=F, message=F, fig.height=10}

coords <- c(top = 52.6899, right = 13.6636, bottom = 52.5054, left = 13.2069)
plot_district("Pankow", coords = coords)

```









<br>

## Reinickendorf

```{r highlight_reinikendorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Reinickendorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_reinikendorf, warning=F, message=F, fig.height=10}

coords <- c(top = 52.6970, right = 13.5238, bottom = 52.5125, left = 13.0672)
plot_district("Reinickendorf", coords = coords)

```








<br>

## Spandau

```{r highlight_spandau, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Spandau")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_spandau, warning=F, message=F, fig.height=10}

coords <- c(top = 52.6118, right = 13.4243, bottom = 52.4269, left = 12.9676)
plot_district("Spandau", coords = coords)

```
---
title: A Tale of One More City
author: Gershom Tripp
date: '2018-12-01'
tags:
  - Berlin
  - Germany
  - Yelp
  - R
  - Dataviz
slug: a-tale-of-one-more-city
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{r load_packages, include=FALSE}
library(tidyverse)
library(ggmap)
library(maps)
library(mapdata)
library(ggstance)
library(gridExtra)
```


```{r load_data, include=FALSE}
# load cleaned yelp data (found here: https://github.com/GershTri/yelp-r)
load("datasets/yelp/berlin_yelp_sf_info.rda")
```

```{r reduce_restructure_yelp_df, include=FALSE}
# extract categories from categories.title.1
cat_titles1 <- yelp_df %>% 
    filter(!is.na(categories.title.1)) %>% 
    select(-categories.title) %>% 
    rename(categories.title = categories.title.1)

# extract categories from categories.title.2
cat_titles2 <- yelp_df %>% 
    filter(!is.na(categories.title.2)) %>% 
    select(-categories.title) %>% 
    rename(categories.title = categories.title.2)

# recombind above data frames with yelp_df and remove unneeded variables
yelp_df <- bind_rows(yelp_df, cat_titles1, cat_titles2) %>% 
    select(-c(alias, image_url, is_closed, url, starts_with("categories.alias"),
              starts_with("location.address"), starts_with("location.disp"),
              phone, display_phone, starts_with("categories.title."),
              location.country
              )
           )

rm(cat_titles1, cat_titles2)
```

Intro here.










## Some Demographics

```{r plot_population_density}
density_breaks <- sort(round(info_district_df$pop_dense))[c(2, 6, 8, 11, 12)]

ggplot(sf_districts) +
    geom_sf(aes(fill = info_district_df$pop_dense)) + 
    scale_fill_viridis_c(breaks = density_breaks) +
    labs(title = "Population Density (People per km^2)", fill = "density") +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)
    )

rm(density_breaks)
```

```{r plot_foreign_residents}
foreign_breaks <- sort(info_district_df$foreign)[c(2, 8, 10, 11, 12)]

ggplot(sf_districts) +
    geom_sf(aes(fill = info_district_df$foreign)) + 
    scale_fill_viridis_c(breaks = foreign_breaks) +
    labs(title = "Proportion of Foreign Residents", fill = "proportion") +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)
    )

rm(foreign_breaks)
```

```{r plot_average_age}
age_breaks <- sort(info_district_df$avg_age)[c(1, 3, 5, 9, 12)]

ggplot(sf_districts) +
    geom_sf(aes(fill = info_district_df$avg_age)) + 
    scale_fill_viridis_c(breaks = age_breaks, direction = -1) +
    labs(title = "Average Age of Residents", fill = "mean") +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)
    )

rm(age_breaks)
```


```{r modify_pol_parties, include=FALSE}
# sum the rows to get proportions
pol_parties$Sum <- rowSums(pol_parties[,2:8])

# translate German and calculate proportion
pol_parties <- pol_parties %>% 
    rename(Rest = Sonstige) %>% 
    mutate(SPD = SPD/Sum,
           CDU = CDU/Sum,
           Grüne = Grüne/Sum,
           Linke = Linke/Sum,
           AfD = AfD/Sum,
           FDP = FDP/Sum,
           Rest = Rest/Sum
           ) %>% 
    select(-Sum) %>% 
    rename(`Die Grünen` = Grüne, `Die Linke` = Linke)

# tidy data frame
pol_parties <- pol_parties %>%
    gather(Party, Proportion, -District) %>% 
    arrange(District)

pol_parties$District <- factor(pol_parties$District,
                               ordered = T,
                               levels = rev(unique(pol_parties$District))
                               )

pol_parties$Party <- factor(pol_parties$Party,
                            ordered = T,
                            levels = c("Die Linke", "SPD", "Die Grünen",
                                       "CDU", "FDP", "AfD", "Rest"
                                       )
                            )

# remove duplicated neukölln
pol_parties <- pol_parties %>% distinct()

# include size scale
dom_berlin <- pol_parties %>% 
    filter(District == "Berlin") %>% 
    select(Party, Proportion)

dom_berlin$Proportion <- c(10, 8.5, 6, 6, 4, 2.5, 1)

dom_berlin <- dom_berlin %>% 
    mutate(Proportion = as.integer(Proportion)) %>% 
    rename(`Dominance - Berlin` = Proportion)

pol_parties <- full_join(pol_parties, dom_berlin, by = "Party")

# manually modify Die Grünen and Die Linke in Berlin to deal with overlap
pol_parties[3, "Dominance - Berlin"] <- 7
pol_parties[4, "Dominance - Berlin"] <- 6


# rank according to afd dominance
afd_dom <- pol_parties %>%
    filter(Party == "AfD") %>% 
    arrange(Proportion) %>% 
    filter(District != "Berlin") %>%
    mutate(afd_rank = 0:11) %>% 
    select(-(2:4))

afd_dom <- rbind(afd_dom, c("Berlin", 12)) %>% 
    mutate(afd_rank = as.integer(afd_rank))

pol_parties <- full_join(pol_parties, afd_dom, by = "District")

pol_parties <- pol_parties %>%
    mutate(District = factor(District,
                             levels = arrange(pol_parties, afd_rank) %>% 
                                 .$District %>% 
                                 unique()
                             )
           )
```


```{r plot_political_parties, fig.height=7, fig.width=6.5}
ggplot(pol_parties, aes(y = District,
                        x = Proportion,
                        group = District,
                        color = Party
                        )
       ) +
    geom_point(size = pol_parties$`Dominance - Berlin`) +
    scale_color_manual(values = c("purple", "red", "#229954", "black",
                                  "#F7DC6F", "#3498DB", "grey"
                                  )
                       ) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          plot.title = element_text(hjust = 0.5)
          ) + 
    ggtitle("Party Dominance by District")
```

```{r plot_afd_representation}
afd_district <- pol_parties %>% 
    filter(Party == "AfD", District != "Berlin")


ggplot(sf_districts) +
    geom_sf(aes(fill = afd_district$Proportion)) + 
    scale_fill_viridis_c() +
    labs(title = "AfD Representation by District", fill = "proportion") +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)
    )
```













## Characterizing Berlin Districts Through Yelp Reviews

First, a glimpse of the data.

```{r show_glimpse}
# filter for berlin and potsdam
yelp_df <- yelp_df %>% 
    filter(location.state == "BE" | location.city %in% c("Berlin", "Potsdam"))

glimpse(yelp_df)
```

Although the total number of observations from the dataset is `r nrow(yelp_df)`,
the total number of businesses is actually `r length(unique(yelp_df$id))`. The
remaining `r nrow(yelp_df) - length(unique(yelp_df$id))` observations are duplicates.

A dot density plot can give us some perspective on the distribution of Yelp-reviewed
businesses. 

```{r plot_dot_density_all_businesses, message=FALSE, warning=FALSE}
berlin_coord <- c(left = 12.9680, bottom = 52.3219, right = 13.8000, top = 52.6918)
berlin_map <- get_stamenmap(berlin_coord, maptype = "toner-background")

yelp_df[is.na(yelp_df$district), "district"] <- "Potsdam"

berlin_map %>% 
    ggmap(darken = .8) +
    geom_point(data = yelp_df %>%
                   select(id,
                          coordinates.latitude,
                          coordinates.longitude,
                          district
                          ) %>% 
                   distinct(),
               aes(coordinates.longitude,
                   coordinates.latitude,
                   color = district
                   ),
               size = 0.1,
               alpha = .3
               ) + 
    ggtitle("Distribution of All Yelp-Reviewed Businesses") + 
    theme(axis.text = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5),
          legend.position = "none"
          )
```

```{r plot_30_most_reviewed_berlin}
#
yelp_df %>% 
    group_by(categories.title) %>% 
    count() %>% 
    arrange(desc(n)) %>%
    head(30) %>% 
    rename(Category = categories.title, Count = n) %>% 
    ungroup() %>% 
    mutate(Category = factor(Category,
                             ordered = T,
                             levels = rev(.$Category)
                             )
           ) %>% 
    ggplot(aes(y = Category, x = Count)) +
    geom_point(shape = 21, fill = "lightblue", size = 2) + 
    scale_x_continuous(breaks = seq(100, 1700, 200)) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank()
          ) + 
    ggtitle("Thirty Categories with the Most Yelp Listings")
```
```{r plot_30_businesses_with_most_reviews}
# 
yelp_df %>% 
    arrange(desc(review_count)) %>%
    select(-categories.title) %>% 
    distinct() %>% 
    head(30) %>% 
    mutate(name = ordered(name, levels = rev(.$name))) %>%
    ggplot(aes(y = name, x = review_count)) +
    geom_point(shape = 21, fill = "salmon", size = 2) + 
    scale_x_continuous(breaks = seq(250, 1000, 150)) +
    theme_minimal() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.title.y = element_blank()
          ) +
    xlab("Number of Reviews") +
    ggtitle("Thirty Businesses with the Most Yelp Reviews")


```




```{r test_incidence_rate}
a_df <- tribble(
    ~cat,   ~cat_city,       ~cat_dist,
    "c1",          10,               3,
    "c2",          20,               2,
    "c3",          30,               5,
    "c4",          40,               2,
    "c5",          50,               9,
    "c6",          60,               4,
    "c7",          70,              22,
    "c8",          80,               4,
    "c9",          90,               1
)

test_df <- a_df %>% 
    mutate(inc = round((cat_dist/cat_city) * 
                               (sum(cat_city)/sum(cat_dist)), 2),
           inc_nocon = round(cat_dist/cat_city, 2),
           diff = round((cat_dist/sum(cat_dist)) -
                              (cat_city/sum(cat_city)), 2)
           )

test_df %>%
    arrange(desc(inc)) %>% 
    mutate(inc_r = 1:9) %>% 
    arrange(desc(inc_nocon)) %>% 
    mutate(inc_nocon_r = 1:9) %>%
    arrange(desc(diff)) %>% 
    mutate(diff_r = 1:9)
```

I have a couple of quibbles regarding the use of the "incidence rate" by Katie
Hempenius, and later used by Ilia Blinderman and Amber Thomas. Katie arrives at an
equation with two goals in mind: "1. identify interesting trends and 2. normalize
for the effects of commercial versus residential usage". She 
[defines](https://katiehempenius.com/post/yelp-map-of-san-francisco/) it thusly:

$$
X = \frac{Category\;Z\;in\;zip}{Category\;Z\;in\;city} \times
\frac{Businesses\;in\;city}{Businesses\;in\;zip}
$$

All of this is well-argued and perfectly reasonable, and I do believe their
results reflect the character of the neighborhoods they are analyzing, to a degree.
That said, there are a few issues - one major, one minor, and one somewhere in
between - that are worth discussing.

Fortunately, the major issue is also the easiest to address. Simply put, the
above equation does not describe the [_incidence rate_](https://www.cdc.gov/ophss/csels/dsepd/ss1978/lesson3/section2.html). The incidence rate is a measure of _new cases_ in a specified period of time, but time doesn't play a role at all in our simple analysis of existent businesses. 

A more appropriate measure might be _prevalence_ (also described the CDC self-study course linked above), which is 

I think most of the confusion here stems from the fact that specific epidemiological terminology is being used in a context where an epidemological approach is perfectly valid, but how the terminology is being used isn't quite right.


Using the proportion `category in district/category in city` can be misleading.





<br>

## Friedrichshain-Kreuzberg

```{r set_up_color_map_function}
district_color_map <- unique(sf_districts$Districts)
district_color_map <- data_frame(district = district_color_map, color = "grey")

district_name <- "Friedrichshain-Kreuzberg"

highlight_district <- function(district_name, color_map = district_color_map){
    color_map[which(color_map$district == district_name), "color"] <- "red"
    color_map
}

```

```{r highlight_friedrichshain_kreuzberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Friedrichshain-Kreuzberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r set_up_dataframe_of_prevalence_diffs, message=FALSE, warning=FALSE}
city_summary <- yelp_df %>% 
    group_by(categories.title) %>% 
    summarise(cat_tot_city = n()) %>% 
    mutate(bus_tot_city = length(unique(yelp_df$id)),
           preval_city = cat_tot_city/nrow(yelp_df)) %>% 
    arrange(desc(preval_city))


dist_summary <- yelp_df %>% 
    group_by(district, categories.title) %>% 
    count() %>%
    full_join(yelp_df %>% group_by(district) %>% count(), by = "district") %>% 
    rename(cat_tot_dist = n.x, bus_tot_dist = n.y) %>% 
    mutate(preval_dist = cat_tot_dist/bus_tot_dist) %>% 
    arrange(district, desc(preval_dist))

diff_df <- full_join(dist_summary, city_summary, by = "categories.title") %>% 
    mutate(preval_diff = preval_dist - preval_city) %>% 
    arrange(district, desc(preval_diff))
```

```{r write_plot_district_function}
plot_district <- function(district_name, coords) {
    
    dist_diff_df <- diff_df %>% 
        filter(district == district_name) %>% 
        head(6)
    
    dist_df <- yelp_df %>% 
        filter(district == district_name,
               categories.title %in% dist_diff_df$categories.title
               ) %>% 
        mutate(categories.title = ordered(categories.title,
                                          levels = dist_diff_df$categories.title
                                          )
               )
    
    coords_df <- tibble(lon = coords[c("top", "bottom")],
                        lat = coords[c("right", "left")]
                        )
    
    qmplot(data = coords_df,
           x = lat,
           y = lon,
           maptype = "terrain",
           geom = "blank"
           ) +
        geom_point(data = dist_df, 
                   aes(x = coordinates.longitude,
                       y = coordinates.latitude,
                       shape = I(21),
                       fill = I("red"),
                       size = review_count,
                       alpha = .5

                       ),
                   ) +
        facet_wrap(~ categories.title, ncol = 2) +
        theme_minimal() +
        theme(axis.title = element_blank(),
              axis.text = element_blank(),
              axis.ticks = element_blank(),
              strip.text = element_text(size=12),
              legend.position = "none"
              )
}

```

```{r plot_top_6_friedrichshain_kreuzberg, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5193, right = 13.4677, bottom = 52.4730, left = 13.3535)
plot_district("Friedrichshain-Kreuzberg", coords = coords)

```









<br>

## Mitte

```{r highlight_mitte, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Mitte")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r plot_top_6_mitte, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5794, right = 13.4797, bottom = 52.4870, left = 13.2514)
plot_district("Mitte", coords = coords)

```











<br>

## Charlottenburg-Wilmersdorf

```{r highlight_charlottenburg_wilmersdorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Charlottenburg-Wilmersdorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```



```{r plot_top_6_charlottenburg_wilmersdorf, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5542, right = 13.3781, bottom = 52.4618, left = 13.1498)
plot_district("Charlottenburg-Wilmersdorf", coords = coords)

```









<br>

## Steglitz-Zehlendorf

```{r highlight_steglitz_zehlendorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Steglitz-Zehlendorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```


```{r plot_top_6_steglitz_zehlendorf, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5221, right = 13.4583, bottom = 52.3368, left = 13.0016)
plot_district("Steglitz-Zehlendorf", coords = coords)

```








<br>

## Tempelhof-Schöneberg

```{r highlight_tempelhof_schöneberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Tempelhof-Schöneberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_tempelhof_schöneberg, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5329, right = 13.6021, bottom = 52.3477, left = 13.1455)
plot_district("Tempelhof-Schöneberg", coords = coords)

```











<br>

## Neukölln

```{r highlight_neukoelln, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Neukölln")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_neukoelln, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5384, right = 13.6903, bottom = 52.3532, left = 13.2337)
plot_district("Neukölln", coords = coords)

```








<br>

## Treptow-Köpenick

```{r highlight_treptow_koepenick, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Treptow-Köpenick")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_treptow_koepenick, warning=F, message=F, fig.height=8}

coords <- c(top = 52.5108, right = 13.8287, bottom = 52.3255, left = 13.3721)
plot_district("Treptow-Köpenick", coords = coords)

```








<br>

## Marzahn-Hellersdorf

```{r highlight_marzahn_hellersdorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Marzahn-Hellersdorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_marzahn_hellersdorf, warning=F, message=F, fig.height=8}

coords <- c(top = 52.6147, right = 13.8160, bottom = 52.4299, left = 13.3594)
plot_district("Marzahn-Hellersdorf", coords = coords)

```









<br>

## Lichtenberg

```{r highlight_lichtenberg, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Lichtenberg")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_lichtenberg, warning=F, message=F, fig.height=8}

coords <- c(top = 52.6243, right = 13.7401, bottom = 52.4395, left = 13.2835)
plot_district("Lichtenberg", coords = coords)

```







<br>

## Pankow

```{r highlight_pankow, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Pankow")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_pankow, warning=F, message=F, fig.height=8}

coords <- c(top = 52.6899, right = 13.6636, bottom = 52.5054, left = 13.2069)
plot_district("Pankow", coords = coords)

```









<br>

## Reinickendorf

```{r highlight_reinikendorf, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Reinickendorf")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_reinikendorf, warning=F, message=F, fig.height=8}

coords <- c(top = 52.6970, right = 13.5238, bottom = 52.5125, left = 13.0672)
plot_district("Reinickendorf", coords = coords)

```








<br>

## Spandau

```{r highlight_spandau, fig.height=1.5, fig.width=2.5}
cmap <- highlight_district("Spandau")

ggplot(sf_districts) +
    geom_sf(aes(fill = cmap$color)) +
    scale_fill_manual(values = c("grey", "red"), guide = F) +
    theme(
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
    )
```

```{r plot_top_6_spandau, warning=F, message=F, fig.height=8}

coords <- c(top = 52.6118, right = 13.4243, bottom = 52.4269, left = 12.9676)
plot_district("Spandau", coords = coords)

```